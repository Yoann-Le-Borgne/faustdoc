
%--------------------------------------------------------------------------------------------------------------
\subsection{Widget Modulation}
%--------------------------------------------------------------------------------------------------------------

Widget modulation allows to add inputs to existing code in order to act on the signals produced internally by its widgets. This operation is done directly by the compiler and doesn't require any modification of the existing code by the user.

A widget modulation consists of a list of target widgets and an expression using them:

\begin{rail}
	modulation : '[' (target + ',') "->" expression ']';
	target : label ( | ':' expression);
\end{rail}
	

Here is a very simple example, assuming freeverb is a fully functional reverb with a \lstinline'"Wet"' slider:

\begin{lstlisting}
["Wet" -> freeverb]
\end{lstlisting}

The resulting circuit will have three inputs instead of two, the additional input acting on the values produced by the \lstinline'"Wet"' widget inside the freeverb expression.

In the following example, the \lstinline'"Wet"' widget is modulated by an LFO:

\begin{lstlisting}
lfo(10, 0.5), _, _ : ["Wet" -> freeverb]
\end{lstlisting}

\subsubsection{Target Widgets}

Target widgets are specified by their label. Of course, this presupposes knowing the names of the sliders. But as these names appear on the user interface, it's easy enough. If several widgets have the same name, adding the names of some (not necessarily all) of the surrounding groups, as in: \lstinline`"h:group/h:subgroup/label"` can help distinguish them. 

Multiple targets can be indicated as in: 

\begin{lstlisting}
["Wet", "Damp", "RoomSize" -> freeverb]
\end{lstlisting}

In this case, three new inputs are added. 

\subsubsection{Modulators}

We haven't said how sliders are modulated. By default, when nothing is specified, the modulator is a multiplication. The previous example is equivalent to the explicit form:

\begin{lstlisting}
["Wet": * -> freeverb]
\end{lstlisting}

\marginpar{Please note that the \lstinline`':'` sign used here is just a visual separator, it is not the sequential composition operator. }
The multiplication can be replaced by any other circuit with at most two inputs, and exactly one output. For example, one could write:

\begin{lstlisting}
["Wet": + -> freeverb]
\end{lstlisting}

to indicate that the modulation signal will be added (instead of multiplied) to the \lstinline`"Wet"` signal.

The only constraint on the modulation circuit is that it must have only one output and at most two inputs. We can therefore have \lstinline`0->1`, \lstinline`1->1`, or \lstinline`2->1` circuits. 

A \lstinline`0->1` modulator being a circuit with no inputs, the target widget is removed from the user interface. Let says that we want to remove the \lstinline`"Damp"` slider and replace it with the constant \lstinline`0.5`, we can write:

\begin{lstlisting}
	["Damp": 0.5 -> freeverb]
\end{lstlisting}
	
A \lstinline`1->1` modulator transforms the signal produced by the widget without external input. Our previous example could be written as:

\begin{lstlisting}
["Wet": *(lfo(10, 0.5)) -> freeverb]
\end{lstlisting}

If \lstinline`lfo` had its own user interface, it would be added to the freeverb interface, at the same level as the \lstinline`"Wet"` slider. 

Finally, a \lstinline`2->1` modulator is a circuit with two inputs, like \lstinline`*`. Its first input is connected to the signal produced by the widget, the second one is the modulation input. Only \lstinline`2->1` circuits create additional inputs. As we already seen, our example could be written as:

\begin{lstlisting}
	lfo(10, 0.5), _, _ : ["Wet": * -> freeverb]
\end{lstlisting}
	
The main diffÃ©rence with the previous case is that if \lstinline`lfo` had its own user interface, it would be added outside of the \lstinline`freeverb` interface.
